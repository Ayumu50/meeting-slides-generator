# T-Shirt Shop - ECサイト

FlaskベースのシンプルなTシャツ販売ECサイトです。

## 機能

- 商品一覧表示
- 商品詳細ページ
- ショッピングカート機能
- チェックアウト（注文）機能
- レスポンシブデザイン

## ローカル環境での実行

### 必要な環境
- Python 3.12以上
- pip

### セットアップ

1. 仮想環境の作成と有効化
```bash
python3 -m venv venv
source venv/bin/activate  # macOS/Linux
# または
venv\Scripts\activate     # Windows
```

2. 依存関係のインストール
```bash
pip install -r requirements.txt
```

3. アプリケーションの起動
```bash
python app.py
```

4. ブラウザで http://localhost:5000 にアクセス

## AWS ECSでのデプロイ（GUIを使用）

### 前提条件
- AWSアカウント
- Docker Desktop（ローカルでのイメージビルド用）
- AWS CLI（オプション）

### 1. ECRリポジトリの作成

1. **AWS Management Console**にログイン
2. **Amazon ECR**サービスに移動
3. **「リポジトリを作成」**をクリック
4. 設定：
   - **リポジトリ名**: `tshirt-shop`
   - **可視性設定**: プライベート
   - その他はデフォルト設定
5. **「リポジトリを作成」**をクリック

### 2. Dockerイメージのビルドとプッシュ

1. **ECRリポジトリ**を開き、**「プッシュコマンドを表示」**をクリック
2. 表示されたコマンドを順番に実行：

```bash
# 1. ECRにログイン
aws ecr get-login-password --region ap-northeast-1 | docker login --username AWS --password-stdin [ACCOUNT_ID].dkr.ecr.ap-northeast-1.amazonaws.com

# 2. Dockerイメージをビルド
docker build -t tshirt-shop .

# 3. イメージにタグを付ける
docker tag tshirt-shop:latest [ACCOUNT_ID].dkr.ecr.ap-northeast-1.amazonaws.com/tshirt-shop:latest

# 4. ECRにプッシュ
docker push [ACCOUNT_ID].dkr.ecr.ap-northeast-1.amazonaws.com/tshirt-shop:latest
```

### 3. VPCとセキュリティグループの設定

#### VPCの確認/作成
1. **Amazon VPC**サービスに移動
2. デフォルトVPCがない場合は**「VPCを作成」**
3. 設定：
   - **VPCのみ**を選択
   - **IPv4 CIDR**: `10.0.0.0/16`
   - **テナンシー**: デフォルト

#### サブネットの確認/作成
1. **サブネット**メニューで、異なるAZに最低2つのパブリックサブネットがあることを確認
2. ない場合は**「サブネットを作成」**で作成

#### セキュリティグループの作成
1. **セキュリティグループ**メニューで**「セキュリティグループを作成」**
2. 設定：
   - **セキュリティグループ名**: `tshirt-shop-sg`
   - **説明**: `Security group for T-shirt shop application`
   - **VPC**: 使用するVPCを選択
3. **インバウンドルール**を追加：
   - **タイプ**: カスタムTCP
   - **ポート範囲**: 5000
   - **ソース**: 0.0.0.0/0（本番環境では適切に制限してください）
4. **「セキュリティグループを作成」**をクリック

### 4. Application Load Balancer（ALB）の作成

1. **EC2**サービス → **ロードバランサー**に移動
2. **「ロードバランサーの作成」**をクリック
3. **Application Load Balancer**を選択
4. 基本設定：
   - **名前**: `tshirt-shop-alb`
   - **スキーム**: インターネット向け
   - **IPアドレスタイプ**: IPv4
5. ネットワークマッピング：
   - **VPC**: 使用するVPCを選択
   - **マッピング**: 最低2つのAZを選択
6. セキュリティグループ：
   - 新しいセキュリティグループを作成または既存のものを選択
   - HTTP（ポート80）を許可
7. リスナーとルーティング：
   - **「ターゲットグループを作成」**をクリック
   - **ターゲットタイプ**: IP
   - **プロトコル**: HTTP
   - **ポート**: 5000
   - **VPC**: 同じVPCを選択
   - **ヘルスチェックパス**: `/`
8. **「作成」**をクリック

### 5. ECSクラスターの作成

1. **Amazon ECS**サービスに移動
2. **「クラスターの作成」**をクリック
3. 設定：
   - **クラスター名**: `tshirt-shop-cluster`
   - **インフラストラクチャ**: AWS Fargate（サーバーレス）
4. **「作成」**をクリック

### 6. タスク定義の作成

1. **タスク定義**メニューで**「新しいタスク定義の作成」**をクリック
2. 基本設定：
   - **タスク定義ファミリー**: `tshirt-shop-task`
   - **起動タイプ**: AWS Fargate
3. インフラストラクチャ要件：
   - **オペレーティングシステム/アーキテクチャ**: Linux/X86_64
   - **CPU**: 0.25 vCPU
   - **メモリ**: 0.5 GB
4. タスクロール：
   - **タスクロール**: ecsTaskRole（存在しない場合は作成）
   - **タスク実行ロール**: ecsTaskExecutionRole
5. コンテナ詳細：
   - **名前**: `tshirt-shop-container`
   - **イメージURI**: `[ACCOUNT_ID].dkr.ecr.ap-northeast-1.amazonaws.com/tshirt-shop:latest`
   - **ポートマッピング**: 
     - **コンテナポート**: 5000
     - **プロトコル**: TCP
6. 環境変数：
   - `FLASK_ENV`: `production`
   - `FLASK_DEBUG`: `False`
7. ログ収集：
   - **ログドライバー**: awslogs
   - **ロググループ**: `/ecs/tshirt-shop`（自動作成）
8. **「作成」**をクリック

### 7. ECSサービスの作成

1. 作成したクラスター内で**「サービス」**タブを選択
2. **「作成」**をクリック
3. デプロイ設定：
   - **アプリケーションタイプ**: サービス
   - **タスク定義**: `tshirt-shop-task`
   - **リビジョン**: LATEST
4. サービス設定：
   - **サービス名**: `tshirt-shop-service`
   - **希望するタスク数**: 2
5. ネットワーキング：
   - **VPC**: 使用するVPCを選択
   - **サブネット**: パブリックサブネットを選択
   - **セキュリティグループ**: 作成したセキュリティグループを選択
   - **パブリックIP**: 有効
6. ロードバランシング：
   - **ロードバランサータイプ**: Application Load Balancer
   - **ロードバランサー**: 作成したALBを選択
   - **リスナー**: 既存のリスナーを選択
   - **ターゲットグループ**: 作成したターゲットグループを選択
7. **「作成」**をクリック

### 8. デプロイの確認

1. **ECSサービス**のステータスが「RUNNING」になることを確認
2. **ターゲットグループ**でヘルスチェックが「healthy」になることを確認
3. **ALBのDNS名**をブラウザでアクセスしてアプリケーションが動作することを確認

### 9. 継続的デプロイメント（オプション）

新しいバージョンをデプロイする場合：

1. 新しいDockerイメージをECRにプッシュ
2. ECSサービスで**「更新」**をクリック
3. **「新しいリビジョンを強制」**にチェック
4. **「更新」**をクリック

## トラブルシューティング

### よくある問題

1. **コンテナが起動しない**
   - CloudWatch Logsでエラーログを確認
   - セキュリティグループの設定を確認

2. **ヘルスチェックが失敗する**
   - アプリケーションが正しいポート（5000）で起動しているか確認
   - ヘルスチェックパスが正しいか確認

3. **ALB経由でアクセスできない**
   - ターゲットグループのヘルスチェック状態を確認
   - セキュリティグループの設定を確認

### ログの確認方法

1. **CloudWatch Logs**に移動
2. ロググループ `/ecs/tshirt-shop` を選択
3. 最新のログストリームを確認

## セキュリティ考慮事項

本番環境では以下の設定を検討してください：

- セキュリティグループの適切な制限
- HTTPS/TLSの設定
- WAFの導入
- 環境変数の暗号化（AWS Systems Manager Parameter Store使用）
- データベースの導入（RDS等）

## コスト最適化

- 不要な時間帯はタスク数を0に設定
- 適切なインスタンスサイズの選択
- CloudWatch Logsの保持期間設定